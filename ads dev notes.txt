When first starting the dev vm
-load eHub plc project - do NOT activate it or put it in RUN mode.
-run the NewAds console app
-result:
    Ads Error: 1 : [AdsClient:TwinCAT.Ads.Internal.INotificationReceiver.OnNotificationError()] 
    Exception: Couldn't register for AdsState change Notifications on the connected ADS Server. 
    Don't register for AdsClient.AdsStateChanged events! (Target port could not be found. 
    (AdsErrorCode: 6, 0x6))
    ...
    Exception thrown: 'TwinCAT.Ads.AdsErrorException' in TwinCAT.Ads.dll
    The program '[6684] NewAds.exe' has exited with code 0 (0x0).

the first part (Ads Error 1...) did not throw an exception when I stepped thru the code.
The exception was thrown when I hit the "client.AddDeviceNotification("vMessages.Msgs_SCP.Ready",..." 
code.


Try again with some code re-shuffling and a new invalid notification handler
When first starting the dev vm
-load eHub plc project - do NOT activate it or put it in RUN mode.
-run the NewAds console app
-result: on the line where I ask for the Ads state (client.ReadState().AdsState) it throws
    Exception thrown: 'TwinCAT.Ads.AdsErrorException' in TwinCAT.Ads.dll
    Target port could not be found.
reading the ads state occurs immediately after the Ads.Connect call

repeating the above but activating the project and loading it and running it, I don't get that
"Don't register for AdsClient.AdsStateChanged events!" in the output window.

Running PLC app. Running Ads app. 
Ads has seen messages.
Open plc program, edit it, login with on-line change
no indication that the plc ads state has changed.
ask plc to create more msgs
msgs recvd by the ads app
I was expecting some sort of exception. guess not.

repeating the above but this time with "Login with download"
got this in the debugger:
    AdsStateChanged(Stop)
    Client_AdsNotificationsInvalidated()
    Exception thrown: 'TwinCAT.Ads.AdsErrorException' in TwinCAT.Ads.dll
    The program '[10068] NewAds.exe' has exited with code 0 (0x0).
got this on the apps console:
    Ads was NOT happy: Key could not be found in hashtable


repeating the above
    I think it faulted when I try to DeleteDeviceNotification(notificationHandle)
    I think bc it's 0. Added Trace statements to verify
Login with download and all this happened:
    AdsStateChanged(Stop)
    Client_AdsNotificationsInvalidated()
    Inner while loop exited.
        AdsIsRunning = False
        notificationHandle = 0
    Inner while loop exited.
        AdsIsRunning = False
        notificationHandle = 3
    Inner while loop exited.
        AdsIsRunning = False
        notificationHandle = 4
    Inner while loop exited.
        AdsIsRunning = False
        notificationHandle = 5
    Inner while loop exited.
        AdsIsRunning = False
        notificationHandle = 6
    Inner while loop exited.
        AdsIsRunning = False
        notificationHandle = 7
    Inner while loop exited.
        AdsIsRunning = False
        notificationHandle = 8
    Inner while loop exited.
        AdsIsRunning = False
        notificationHandle = 9
    Client_AdsNotification()
    Inner while loop exited.
        AdsIsRunning = False
        notificationHandle = 10
    Inner while loop exited.
        AdsIsRunning = False
        notificationHandle = 11
    Inner while loop exited.
        AdsIsRunning = False
        notificationHandle = 12
At this point I exited the program because I wanted to log all this down

Reran the above. But this time:
After Login with download I hit play on the plc program to let it run again.
then I asked it to start making msgs again.
Exception!
Here's the debugger:
    AdsStateChanged(Run)        -- this is when I hit play
    Client_AdsNotification()
    Client_AdsNotification()
    Exception thrown: 'TwinCAT.Ads.AdsErrorException' in TwinCAT.Ads.dll        -- where did this come from????
    exception when processing sending buffer    -- this is in the handle tag change - or is it.
    Client_AdsNotification()
    Client_AdsNotification()
    Exception thrown: 'TwinCAT.Ads.AdsErrorException' in TwinCAT.Ads.dll
    exception when processing sending buffer
    Exception thrown: 'TwinCAT.Ads.AdsErrorException' in TwinCAT.Ads.dll
    An exception of type 'TwinCAT.Ads.AdsErrorException' occurred in TwinCAT.Ads.dll but was not handled in user code
    Symbol version is invalid. (AdsErrorCode: 1809, 0x711)
Not sure why I got 4 AdsNotification events with an exception in the middle and then another after.
I'm starting to wonder if the AdsNotification covers more than just a tag change.


Repeating above. I added some logging to the AdsNotification function to list out some the eventargs
Made a change - logged in with download
    AdsStateChanged(Stop)
    Client_AdsNotificationsInvalidated()
    Inner while loop exited.
        AdsIsRunning = False
        notificationHandle = 0
    Inner while loop exited.
        AdsIsRunning = False
        notificationHandle = 3
    Client_AdsNotification()        
-- why am I getting these? bc when the loop comes back around it re-registers the buffer
-- and you get an initial value
        e.handle 3
        e.Data.Span[0] = 0
        ackHandle = 0
        bufferHandle = 0
    Inner while loop exited.
        AdsIsRunning = False
        notificationHandle = 4
    Client_AdsNotification()
        e.handle 4
        e.Data.Span[0] = 0
        ackHandle = 0
        bufferHandle = 0
    AdsStateChanged(Run)            -- I hit play
    Client_AdsNotification()
        e.handle 5
        e.Data.Span[0] = 0
        ackHandle = 0
        bufferHandle = 0
plc program is still running - no faults in the console app yet
ask plc to make more msgs...
faults immediately:
    Client_AdsNotification()
        e.handle 5
        e.Data.Span[0] = 1
        ackHandle = 0
        bufferHandle = 0
    Exception thrown: 'TwinCAT.Ads.AdsErrorException' in TwinCAT.Ads.dll        -- WHERE IS THIS COMING FROM????
    exception when processing sending buffer
    Client_AdsNotification()
        e.handle 5
        e.Data.Span[0] = 0
        ackHandle = 461373443
        bufferHandle = 461373444
    Client_AdsNotification()
        e.handle 5
        e.Data.Span[0] = 1
        ackHandle = 461373443
        bufferHandle = 461373444
    Exception thrown: 'TwinCAT.Ads.AdsErrorException' in TwinCAT.Ads.dll
    exception when processing sending buffer
    Exception thrown: 'TwinCAT.Ads.AdsErrorException' in TwinCAT.Ads.dll
    An exception of type 'TwinCAT.Ads.AdsErrorException' occurred in TwinCAT.Ads.dll but was not handled in user code
    Symbol version is invalid. (AdsErrorCode: 1809, 0x711)
when the dust settled and the debugger popped up. it was stopped on the client.DeleteVariableHandle(bufferHandle)
I'm thinkg that maybe not do global handles and keep it local. what kind of overhead could that cause?

I did that, just use local vars for the ack and buffer handle and it worked perfectly.


repeat but this time my edit was to change the code in the main prgram - exception
    AdsStateChanged(Stop)
    Client_AdsNotificationsInvalidated()
    Inner while loop exited.
        AdsIsRunning = False
        notificationHandle = 0
    The thread '.NET TP Worker' (9352) has exited with code 0 (0x0).
    The thread '.NET TP Worker' (4720) has exited with code 0 (0x0).
    AdsStateChanged(Run)        -- this was me hitting play
    Exception thrown: 'TwinCAT.Ads.AdsErrorException' in TwinCAT.Ads.dll
    The program '[10192] NewAds.exe' has exited with code 0 (0x0).
the console had this to say:
    Symbol version is invalid
I need to try to keep a running log of the devicenotification handle
notice it was 0 when the inner loop exited. what happened in the meantime?
I should log what it is when I add the notification




